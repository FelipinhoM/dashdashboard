<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b14;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --bg-glass: rgba(17, 24, 39, 0.8);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-accent: #3b82f6;
            --accent-primary: #3b82f6;
            --accent-secondary: #06b6d4;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border-glass: rgba(59, 130, 246, 0.2);
            --shadow-glow: 0 0 50px rgba(59, 130, 246, 0.15);
            --shadow-card: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #06b6d4 50%, #10b981 100%);
            --gradient-secondary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #10b981 100%);
            --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #4facfe 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Glassmorphism Component */
        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 24px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
        }

        /* Modern Button Component */
        .btn {
            position: relative;
            padding: 1rem 2rem;
            border: none;
            border-radius: 16px;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            overflow: hidden;
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.4);
        }

        .btn:active {
            transform: translateY(-2px);
        }

        /* Custom Input Component */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1), 0 0 20px rgba(139, 92, 246, 0.2);
        }

        /* Custom Select Component */
        .select-wrapper {
            position: relative;
        }

        .select-field {
            width: 100%;
            padding: 1rem 3rem 1rem 1.5rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
        }

        .select-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1), 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            top: 50%;
            right: 1.5rem;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.75rem;
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        .select-wrapper:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-container {
            width: 100%;
            max-width: 480px;
            padding: 3rem;
            margin: 2rem;
        }

        .login-card {
            padding: 3rem;
            text-align: center;
            position: relative;
        }

        .login-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 3rem;
            font-size: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .login-error {
            background: linear-gradient(135deg, var(--accent-danger), #dc2626);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
            font-weight: 500;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .header-title {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            line-height: 1.1;
        }

        .header-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Upload Section */
        .upload-section {
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .file-input-btn {
            padding: 1.5rem 3rem;
            background: var(--gradient-secondary);
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
        }

        .file-input-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .file-input-btn:hover::before {
            left: 100%;
        }

        .file-input-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(6, 182, 212, 0.4);
        }

        /* Filters */
        .filters {
            padding: 2rem;
            margin-bottom: 3rem;
        }

        .filters-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--text-primary);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filter-apply {
            text-align: center;
            margin-top: 2rem;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Area Sections */
        .area-section {
            margin-bottom: 4rem;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .area-header {
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-bottom: 1px solid var(--border-glass);
        }

        .area-title {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .area-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .area-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .badge-trafego { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        .badge-revenue { 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .badge-consultoria { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .badge-recuperacao { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .badge-criativos { 
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        /* Tab System */
        .tabs-container {
            background: var(--bg-secondary);
            border-radius: 0 0 20px 20px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--border-glass);
            padding: 0 2rem;
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 0 0 20px 20px;
        }

        /* Atendentes Grid */
        .atendentes-container {
            padding: 2rem;
        }

        .atendente-card {
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-glass);
            transition: all 0.3s ease;
        }

        .atendente-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
        }

        .atendente-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-glass);
        }

        .atendente-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .atendente-badge {
            padding: 0.5rem 1rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .atendente-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-glass);
        }

        .metric-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .atendente-responses {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .response-item {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-glass);
        }

        .response-question {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .response-answer {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .kpi-card {
            padding: 2rem;
            border-radius: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-glass);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-glow);
            border-color: var(--accent-primary);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .kpi-emoji {
            font-size: 1.5rem;
        }

        .kpi-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .kpi-change {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-change.positive {
            background: linear-gradient(135deg, var(--accent-success), #059669);
            color: white;
        }

        .kpi-change.negative {
            background: linear-gradient(135deg, var(--accent-danger), #dc2626);
            color: white;
        }

        .kpi-change.neutral {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        /* Charts */
        .chart-card {
            padding: 2rem;
            margin-top: 2rem;
            border-radius: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-glass);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* Pie Charts */
        .pie-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 3rem;
            margin-bottom: 4rem;
        }

        .pie-chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Observations */
        .observations {
            padding: 2rem;
            margin-bottom: 4rem;
            border-radius: 20px;
        }

        .observation-item {
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        .observation-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-glow);
        }

        .observation-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .observation-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .observation-text {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Data Table */
        .data-table {
            padding: 2rem;
            border-radius: 20px;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border-glass);
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-primary);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        .error-message {
            background: linear-gradient(135deg, var(--accent-danger), #dc2626);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-title {
                font-size: 2.5rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .pie-charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
        }

        /* Custom option styling for selects */
        option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        /* NOVO: Estilos para o Resumo Executivo */
        .holding-summary {
            animation: fadeInUp 0.8s ease-out;
        }

        .summary-grid {
            animation: staggerFadeIn 1s ease-out;
        }

        .summary-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .summary-card:hover::before {
            left: 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes staggerFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            50% {
                opacity: 0.5;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Anima√ß√£o para os valores quando atualizarem */
        .summary-card div[id*="Total"],
        .summary-card div[id*="Lucro"],
        .summary-card div[id*="margem"] {
            animation: countUp 0.6s ease-out;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-card glass-card">
                <h1 class="login-title">üöÄ DASHBOARD</h1>
                <p class="login-subtitle">Plataforma Avan√ßada de Analytics</p>
                
                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <label>Senha de Acesso</label>
                        <input type="password" id="password" class="input-field" placeholder="Digite sua senha" required>
                    </div>
                    <button type="submit" class="btn">Entrar</button>
                </form>
                
                <div class="login-error" id="loginError">
                    Senha inv√°lida. Tente novamente.
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1 class="header-title">DASHBOARD EXECUTIVO</h1>
            <p class="header-subtitle">Plataforma de Business Intelligence e Analytics de Performance em Tempo Real</p>
        </div>

        <div class="upload-section glass-card" id="uploadSection">
            <h3 class="upload-title">üìä Carregar Dados</h3>
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv">
                <button class="file-input-btn">
                    Selecionar Arquivo CSV
                </button>
            </div>
            <p style="margin-top: 1.5rem; color: var(--text-secondary);">
                Fa√ßa upload dos seus dados CSV para iniciar a an√°lise
            </p>
        </div>

        <div class="filters glass-card" id="filtersSection">
            <h3 class="filters-title">üîç Filtros Avan√ßados</h3>
            <div class="filters-grid">
                <div class="input-group">
                    <label>üìÖ Data Inicial</label>
                    <input type="date" id="startDate" class="input-field">
                </div>
                <div class="input-group">
                    <label>üìÖ Data Final</label>
                    <input type="date" id="endDate" class="input-field">
                </div>
                <div class="input-group">
                    <label>üè¢ Holding</label>
                    <div class="select-wrapper">
                        <select id="holdingFilter" class="select-field">
                            <option value="">Todas as Holdings</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>üì¶ Produto</label>
                    <div class="select-wrapper">
                        <select id="produtoFilter" class="select-field">
                            <option value="">Todos os Produtos</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>üìã √Årea</label>
                    <div class="select-wrapper">
                        <select id="tipoFormularioFilter" class="select-field">
                            <option value="">Todas as √Åreas</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-apply">
                <button class="btn" onclick="applyFilters()">Aplicar Filtros</button>
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Processando dados...</p>
            </div>

            <!-- NOVO: Resumo Geral da Holding -->
            <div class="holding-summary" id="holdingSummary" style="margin-bottom: 3rem;">
                <h3 class="section-title">üíº Resumo Executivo da Holding</h3>
                
                <!-- NOVO: Indicador de convers√£o de moeda -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div id="currencyIndicator" style="display: inline-flex; align-items: center; gap: 0.5rem; background: var(--bg-tertiary); padding: 0.75rem 1.5rem; border-radius: 50px; border: 1px solid var(--border-glass);">
                        <span style="font-size: 1rem;">üí±</span>
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">Cota√ß√£o USD/BRL:</span>
                        <span id="currentRate" style="color: var(--accent-primary); font-weight: 600;">R$ 5,60</span>
                        <span id="rateSource" style="background: var(--accent-primary); color: white; padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">FIXO</span>
                    </div>
                </div>
                
                <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div class="summary-card glass-card" style="padding: 2.5rem; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient-primary);"></div>
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üí∞</div>
                        <h4 style="color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">Faturamento Total</h4>
                        <div id="faturamentoTotal" style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">R$ 0,00</div>
                        <div id="faturamentoChange" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;"></div>
                    </div>
                    
                    <div class="summary-card glass-card" style="padding: 2.5rem; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient-secondary);"></div>
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div>
                        <h4 style="color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">Lucro L√≠quido</h4>
                        <div id="lucroTotal" style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">R$ 0,00</div>
                        <div id="lucroChange" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;"></div>
                    </div>
                    
                    <div class="summary-card glass-card" style="padding: 2.5rem; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient-accent);"></div>
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                        <h4 style="color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem;">Margem de Lucro</h4>
                        <div id="margemLucro" style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">0%</div>
                        <div id="margemChange" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;"></div>
                    </div>
                </div>
            </div>

            <div class="kpi-section" id="kpiSection">
                <h3 class="section-title">üìä An√°lise por √Årea</h3>
                <div id="areasContainer"></div>
            </div>

            <div id="pieChartsSection">
                <h3 class="section-title">üéØ Vis√£o Financeira</h3>
                <div class="pie-charts-grid" id="pieChartsGrid"></div>
            </div>

            <div id="observationsSection">
                <h3 class="section-title">üìù Insights Estrat√©gicos</h3>
                <div class="observations glass-card" id="observationsContainer"></div>
            </div>

            <div id="dataTableSection">
                <h3 class="section-title">üìã Dados Detalhados</h3>
                <div class="data-table glass-card" id="dataTableContainer"></div>
            </div>

            <!-- Debug Section - Movido para o final -->
            <div id="debugSection" style="margin-top: 2rem;">
                <h3 class="section-title">üîß Debug & Ferramentas</h3>
                <div class="glass-card" style="padding: 2rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button class="btn" onclick="showAllDates()" style="background: var(--gradient-secondary);">Ver Todas as Datas</button>
                        <button class="btn" onclick="toggleDebugInfo()" style="background: var(--gradient-accent);">Mostrar/Ocultar Debug</button>
                        <button class="btn" onclick="toggleFaturamentoDebug()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Debug Faturamento</button>
                    </div>
                    
                    <div id="dateDebugInfo" style="padding: 1rem; background: var(--bg-tertiary); border-radius: 12px; display: none; margin-bottom: 2rem;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 0.5rem;">üîç Debug do Filtro de Data</h4>
                        <div id="dateDebugContent"></div>
                    </div>

                    <!-- NOVO: Debug detalhado do faturamento -->
                    <div id="faturamentoDebugInfo" style="padding: 1rem; background: var(--bg-tertiary); border-radius: 12px; display: none;">
                        <h4 style="color: var(--accent-warning); margin-bottom: 1rem;">üí∞ Debug do C√°lculo de Faturamento</h4>
                        <div id="faturamentoDebugContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let filteredData = [];
        let charts = {};
        
        // NOVO: Vari√°vel global para cota√ß√£o do d√≥lar
        let dollarRate = 5.60; // Fallback fixo
        let dollarRateSource = 'fixo'; // 'api' ou 'fixo'

        // Area configuration with emojis and modern colors
        const areaConfig = {
            'Tr√°fego': {
                indicators: [
                    { field: 'Gasto', type: 'currency', emoji: 'üí∞' },
                    { field: 'Vendas', type: 'number', emoji: 'üìà' },
                    { field: 'Vendas_Front', type: 'number', emoji: 'üéØ' },
                    { field: 'ROI', type: 'median', emoji: 'üíπ' },
                    { field: 'Compras_Front', type: 'number', emoji: 'üõí' },
                    { field: 'Campanhas_Amanha', type: 'number', emoji: 'üì±' },
                    { field: 'Variantes_Testadas', type: 'number', emoji: 'üß™' },
                    { field: 'Variantes_Validadas', type: 'number', emoji: '‚úÖ' },
                    { field: 'Criativos_Testados', type: 'number', emoji: 'üé®' },
                    { field: 'Criativos_Rodaram', type: 'exact', emoji: 'üî¥' },
                    { field: 'Criativos_Amanha', type: 'exact', emoji: 'üîú' }
                ],
                observation: 'Observacao_Trafego',
                color: '#3b82f6',
                badge: 'badge-trafego'
            },
            'Revenue': {
                indicators: [
                    { field: 'FTD_vs_Vendas_Front', type: 'percentage', emoji: 'üí∏' },
                    { field: 'Registro_vs_Vendas_Front', type: 'percentage', emoji: 'üìä' },
                    { field: 'Revenue_Share', type: 'currency', currency: 'USD', emoji: 'üíµ' },
                    { field: 'Media_Deposito', type: 'average', currency: 'USD', emoji: '‚öñÔ∏è' },
                    { field: 'Valor_Depositado', type: 'currency', currency: 'USD', emoji: 'üí∂' },
                    { field: 'Lives_Feitass', type: 'number', emoji: 'üì∫' },
                    { field: 'Acessos_Liberados', type: 'number', emoji: 'üîì' },
                    { field: 'Quantidade_Depositos', type: 'number', emoji: 'üè¶' }
                ],
                observation: 'Observacao_Revenue',
                color: '#10b981',
                badge: 'badge-revenue'
            },
            'Consultoria': {
                indicators: [
                    { field: 'Num_Pessoas_Planejamento', type: 'number', emoji: 'üë•' },
                    { field: 'Pessoas_Que_Chamou_Planejamento', type: 'number', emoji: 'üìû' },
                    { field: 'Pessoas_Que_Revelou_Valor_Planejamento', type: 'number', emoji: 'üí°' },
                    { field: 'Valor_Consultorias_Vendidas', type: 'currency', emoji: 'üí∞' },
                    { field: 'Consultorias_Vendidas', type: 'number', emoji: 'üìã' },
                    { field: 'Google_Meet_Concluidos', type: 'number', emoji: 'üìπ' },
                    { field: 'Pessoas_Abordadas_Novas_Formulario', type: 'number', emoji: 'üìù' },
                    { field: 'Pessoas_Abordadas_Compraram_10_Dias', type: 'number', emoji: '‚è∞' }
                ],
                observation: 'Observacao_Consultoria',
                color: '#f59e0b',
                badge: 'badge-consultoria'
            },
            'Recuperacao': {
                indicators: [
                    { field: 'Total_Deposito_Dia', type: 'currency', emoji: 'üí≥' },
                    { field: 'Total_Vendido', type: 'currency', emoji: 'üíé' },
                    { field: 'Abandono_Carrinho', type: 'number', emoji: 'üõë' },
                    { field: 'Cartao_Recusado', type: 'number', emoji: '‚ùå' },
                    { field: 'Ligacoes_Atendidas', type: 'number', emoji: '‚òéÔ∏è' },
                    { field: 'Vendas_Por_Ligacao', type: 'number', emoji: 'üì≤' },
                    { field: 'Vendas_PIX_Pendente', type: 'number', emoji: '‚è≥' }
                ],
                observation: 'Observacao_Recuperacao',
                color: '#ef4444',
                badge: 'badge-recuperacao'
            },
            'Criativos': {
                indicators: [
                    { field: 'Criativos_Editados_Do_Zero', type: 'exact', emoji: 'üÜï' },
                    { field: 'Criativos_Reprovados_Pelo_Lucas', type: 'exact', emoji: 'üö´' },
                    { field: 'Variantes_Criadas', type: 'exact', emoji: 'üéØ' },
                    { field: 'Variantes_Editadas', type: 'exact', emoji: '‚úèÔ∏è' }
                ],
                observation: null,
                color: '#06b6d4',
                badge: 'badge-criativos'
            }
        };

        document.getElementById('csvFile').addEventListener('change', handleFile);
        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        // NOVA FUN√á√ÉO: Buscar cota√ß√£o do d√≥lar
        async function fetchDollarRate() {
            try {
                console.log('üîÑ Buscando cota√ß√£o atual do d√≥lar...');
                
                // Tentar v√°rias APIs de cota√ß√£o
                const apis = [
                    'https://api.exchangerate-api.com/v4/latest/USD',
                    'https://api.fixer.io/latest?base=USD&access_key=free', // Fallback
                    'https://economia.awesomeapi.com.br/last/USD-BRL' // API brasileira
                ];
                
                // Primeira tentativa - ExchangeRate API
                try {
                    const response = await fetch(apis[0]);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.rates && data.rates.BRL) {
                            dollarRate = parseFloat(data.rates.BRL);
                            dollarRateSource = 'api-exchangerate';
                            console.log(`‚úÖ Cota√ß√£o obtida via API: USD 1 = R$ ${dollarRate.toFixed(4)}`);
                            return;
                        }
                    }
                } catch (e) {
                    console.log('‚ùå ExchangeRate API falhou');
                }
                
                // Segunda tentativa - API brasileira
                try {
                    const response = await fetch(apis[2]);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.USDBRL && data.USDBRL.bid) {
                            dollarRate = parseFloat(data.USDBRL.bid);
                            dollarRateSource = 'api-awesomeapi';
                            console.log(`‚úÖ Cota√ß√£o obtida via AwesomeAPI: USD 1 = R$ ${dollarRate.toFixed(4)}`);
                            return;
                        }
                    }
                } catch (e) {
                    console.log('‚ùå AwesomeAPI falhou');
                }
                
                // Se todas as APIs falharam, usar cota√ß√£o fixa
                throw new Error('Todas as APIs falharam');
                
            } catch (error) {
                console.log(`‚ö†Ô∏è Erro ao buscar cota√ß√£o: ${error.message}`);
                console.log(`üìå Usando cota√ß√£o fixa: USD 1 = R$ ${dollarRate.toFixed(2)}`);
                dollarRateSource = 'fixo';
            }
        }

        // NOVA FUN√á√ÉO: Converter d√≥lar para real
        function convertUsdToBrl(usdValue) {
            if (!usdValue || isNaN(usdValue)) return 0;
            return parseFloat(usdValue) * dollarRate;
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const password = document.getElementById('password').value;
            const loadingBtn = event.target.querySelector('.btn');
            const originalText = loadingBtn.textContent;
            
            // Show loading state
            loadingBtn.textContent = 'Verificando...';
            loadingBtn.disabled = true;
            document.getElementById('loginError').style.display = 'none';
            
            try {
                // NOVO: Buscar cota√ß√£o do d√≥lar primeiro
                await fetchDollarRate();
                
                const response = await fetch('https://primary-production-1121.up.railway.app/webhook/dados', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${password}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Authentication successful
                    const csvText = await response.text();
                    
                    // Hide login screen and show dashboard
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    // Process the CSV data automatically
                    processCsvFromText(csvText);
                    
                } else if (response.status === 401) {
                    // Invalid password
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                } else {
                    // Other error
                    alert('Erro no servidor. Tente novamente.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Erro de conex√£o. Verifique sua internet e tente novamente.');
            } finally {
                // Reset button state
                loadingBtn.textContent = originalText;
                loadingBtn.disabled = false;
            }
        }

        function processCsvFromText(csvText) {
            document.getElementById('loading').style.display = 'block';
            
            // NOVO: Buscar cota√ß√£o se ainda n√£o foi buscada
            if (dollarRateSource === 'fixo' && dollarRate === 5.60) {
                fetchDollarRate().then(() => {
                    // Reprocessar ap√≥s obter cota√ß√£o
                    console.log('üîÑ Reprocessando com nova cota√ß√£o...');
                });
            }
            
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete: function(results) {
                    processCsvData(results.data);
                },
                error: function(error) {
                    alert('Erro ao processar dados: ' + error.message);
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';

            // NOVO: Buscar cota√ß√£o antes de processar arquivo
            fetchDollarRate().then(() => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        processCsvData(results.data);
                    },
                    error: function(error) {
                        alert('Error processing file: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                    }
                });
            });
        }

        // NOVA FUN√á√ÉO: Normalizar data para compara√ß√£o (apenas dia/m√™s/ano)
        function normalizeDate(date) {
            if (!date) return null;
            const normalized = new Date(date);
            normalized.setHours(0, 0, 0, 0);
            return normalized;
        }

        // NOVA FUN√á√ÉO: Parse melhorado de datas
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                dateStr = dateStr.toString().trim();
                let parsedDate = null;

                // Formato DD/MM/YYYY ou DD/MM/YY
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        let day = parseInt(parts[0]);
                        let month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                        let year = parseInt(parts[2]);
                        
                        // Handle 2-digit years
                        if (year < 100) {
                            year += year < 50 ? 2000 : 1900;
                        }
                        
                        parsedDate = new Date(year, month, day);
                    }
                }
                // Formato YYYY-MM-DD
                else if (dateStr.includes('-')) {
                    parsedDate = new Date(dateStr);
                }
                // Formato DD.MM.YYYY
                else if (dateStr.includes('.')) {
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        let day = parseInt(parts[0]);
                        let month = parseInt(parts[1]) - 1;
                        let year = parseInt(parts[2]);
                        parsedDate = new Date(year, month, day);
                    }
                }

                // Verificar se a data √© v√°lida
                if (parsedDate && !isNaN(parsedDate.getTime())) {
                    return normalizeDate(parsedDate);
                }
                
                return null;
            } catch (e) {
                console.warn('Date parsing error for:', dateStr, e);
                return null;
            }
        }

        function processCsvData(data) {
            csvData = data.filter(row => row && row.Data && row.Tipo_Formulario);
            
            if (csvData.length === 0) {
                alert('No valid data found');
                document.getElementById('loading').style.display = 'none';
                return;
            }

            csvData.forEach(row => {
                if (row.Data) {
                    row.parsedDate = parseDate(row.Data);
                    // Log para debug - pode remover em produ√ß√£o
                    if (row.parsedDate) {
                        console.log(`Data original: ${row.Data} -> Parseada: ${row.parsedDate.toLocaleDateString('pt-BR')}`);
                    }
                }

                Object.keys(row).forEach(key => {
                    if (row[key] && typeof row[key] === 'string' && 
                        key !== 'Data' && key !== 'Tipo_Formulario' && key !== 'Holding' && key !== 'Produto') {
                        
                        if (key.includes('Criativos_Rodaram') || key.includes('Criativos_Amanha') || 
                            key.includes('Criativos_Editados') || key.includes('Variantes_')) {
                            const exactValue = parseInt(row[key]);
                            if (!isNaN(exactValue)) {
                                row[key + '_num'] = exactValue;
                            }
                        } else {
                            const cleaned = row[key].replace(/[^\d.,-]/g, '').replace(',', '.');
                            const numValue = parseFloat(cleaned);
                            if (!isNaN(numValue)) {
                                row[key + '_num'] = numValue;
                            }
                        }
                    }
                });
            });

            setupFilters();
            filteredData = [...csvData];
            
            // NOVO: Atualizar indicador de cota√ß√£o na primeira carga
            updateCurrencyIndicator();
            
            generateDashboard();
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function setupFilters() {
            const holdings = [...new Set(csvData.map(row => row.Holding).filter(Boolean))];
            const produtos = [...new Set(csvData.map(row => row.Produto).filter(Boolean))];
            const tiposFormulario = [...new Set(csvData.map(row => row.Tipo_Formulario).filter(Boolean))];

            populateSelect('holdingFilter', holdings);
            populateSelect('produtoFilter', produtos);
            populateSelect('tipoFormularioFilter', tiposFormulario);

            const dates = csvData.map(row => row.parsedDate).filter(Boolean);
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                document.getElementById('startDate').value = formatDateForInput(minDate);
                document.getElementById('endDate').value = formatDateForInput(maxDate);
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            if (selectId === 'holdingFilter') {
                select.innerHTML = '<option value="">Todas as Holdings</option>';
            } else if (selectId === 'produtoFilter') {
                select.innerHTML = '<option value="">Todos os Produtos</option>';
            } else if (selectId === 'tipoFormularioFilter') {
                select.innerHTML = '<option value="">Todas as √Åreas</option>';
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // FUN√á√ÉO CORRIGIDA: Parse de data do input (evita problemas de timezone)
        function parseDateFromInput(dateInput) {
            if (!dateInput) return null;
            
            // Input vem no formato YYYY-MM-DD, vamos criar a data manualmente
            const parts = dateInput.split('-');
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
            const day = parseInt(parts[2]);
            
            // Criar data local (sem timezone issues)
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);
            
            return date;
        }

        // FUN√á√ÉO COMPLETAMENTE REESCRITA: Filtro de data 100% funcional
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const holding = document.getElementById('holdingFilter').value;
            const produto = document.getElementById('produtoFilter').value;
            const tipoFormulario = document.getElementById('tipoFormularioFilter').value;

            // CORRE√á√ÉO: Parse correto das datas do input (sem timezone issues)
            let startDateObj = null;
            let endDateObj = null;
            
            if (startDate) {
                startDateObj = parseDateFromInput(startDate);
                console.log(`Data inicial selecionada: ${startDate} -> Interpretada como: ${startDateObj.toLocaleDateString('pt-BR')}`);
            }
            
            if (endDate) {
                endDateObj = parseDateFromInput(endDate);
                console.log(`Data final selecionada: ${endDate} -> Interpretada como: ${endDateObj.toLocaleDateString('pt-BR')}`);
            }

            filteredData = csvData.filter(row => {
                // Filtro de data CORRIGIDO
                if (startDateObj && row.parsedDate) {
                    if (row.parsedDate < startDateObj) {
                        return false;
                    }
                }
                
                if (endDateObj && row.parsedDate) {
                    if (row.parsedDate > endDateObj) {
                        return false;
                    }
                }
                
                // Outros filtros
                if (holding && row.Holding !== holding) return false;
                if (produto && row.Produto !== produto) return false;
                if (tipoFormulario && row.Tipo_Formulario !== tipoFormulario) return false;
                
                return true;
            });

            // Logs detalhados para debug
            console.log('=== RESULTADO DO FILTRO ===');
            console.log(`Total de registros originais: ${csvData.length}`);
            console.log(`Registros ap√≥s filtro: ${filteredData.length}`);
            
            // Atualizar debug visual (se estiver vis√≠vel)
            const debugInfo = document.getElementById('dateDebugInfo');
            const debugContent = document.getElementById('dateDebugContent');
            
            if (startDate || endDate) {
                console.log('=== DATAS DOS REGISTROS FILTRADOS ===');
                const uniqueDates = [...new Set(filteredData.map(row => 
                    row.parsedDate ? row.parsedDate.toLocaleDateString('pt-BR') : 'Data inv√°lida'
                ))].sort();
                console.log('Datas presentes:', uniqueDates);
                
                // Atualizar conte√∫do do debug (mas n√£o mostrar automaticamente)
                debugContent.innerHTML = `
                    <p><strong>Per√≠odo selecionado:</strong> ${startDateObj ? startDateObj.toLocaleDateString('pt-BR') : 'N√£o definido'} at√© ${endDateObj ? endDateObj.toLocaleDateString('pt-BR') : 'N√£o definido'}</p>
                    <p><strong>Registros encontrados:</strong> ${filteredData.length} de ${csvData.length} total</p>
                    <p><strong>Datas presentes nos dados:</strong> ${uniqueDates.join(', ')}</p>
                    ${startDate && endDate && startDate === endDate ? '<p style="color: var(--accent-success);">‚úÖ <strong>Filtro de dia √∫nico ativado</strong></p>' : ''}
                `;
            }

            generateDashboard();
        }

        function generateDashboard() {
            try {
                generateHoldingSummary();
                generateAreasWithCharts();
                generatePieCharts();
                generateObservations();
                generateDataTable();
            } catch (error) {
                console.error('Dashboard generation error:', error);
            }
        }

        // FUN√á√ÉO MELHORADA: Gerar resumo executivo da holding
        function generateHoldingSummary() {
            let faturamentoTotal = 0;
            let gastosTotal = 0;
            
            // NOVO: Vari√°veis para debug detalhado
            let faturamentoTrafego = 0;
            let faturamentoRevenue = 0;
            let faturamentoConsultoria = 0;
            let faturamentoRecuperacao = 0;
            let gastosDebug = 0;
            
            // Arrays para calcular tend√™ncias
            const faturamentoPorData = {};
            const gastosPorData = {};
            
            // Calcular faturamento e gastos por √°rea e por data
            filteredData.forEach(row => {
                const area = row.Tipo_Formulario;
                const dataKey = row.parsedDate ? row.parsedDate.toLocaleDateString('pt-BR') : 'sem_data';
                
                if (!faturamentoPorData[dataKey]) faturamentoPorData[dataKey] = 0;
                if (!gastosPorData[dataKey]) gastosPorData[dataKey] = 0;
                
                if (area === 'Tr√°fego') {
                    const vendas = parseFloat(row.Vendas) || parseFloat(row.Vendas_num) || 0;
                    const gastos = parseFloat(row.Gasto) || parseFloat(row.Gasto_num) || 0;
                    faturamentoTotal += vendas;
                    gastosTotal += gastos;
                    faturamentoPorData[dataKey] += vendas;
                    gastosPorData[dataKey] += gastos;
                    
                    // Debug
                    faturamentoTrafego += vendas;
                    gastosDebug += gastos;
                } else if (area === 'Revenue') {
                    // ALTERA√á√ÉO: Converter Revenue Share de USD para BRL
                    const revenueShareUsd = parseFloat(row.Revenue_Share) || parseFloat(row.Revenue_Share_num) || 0;
                    const revenueShareBrl = convertUsdToBrl(revenueShareUsd);
                    faturamentoTotal += revenueShareBrl;
                    faturamentoPorData[dataKey] += revenueShareBrl;
                    
                    // Debug - salvar valores originais e convertidos
                    faturamentoRevenue += revenueShareBrl;
                    if (!row._revenueDebug) {
                        row._revenueDebug = {
                            originalUsd: revenueShareUsd,
                            convertedBrl: revenueShareBrl,
                            rate: dollarRate
                        };
                    }
                } else if (area === 'Consultoria') {
                    const valorConsultorias = parseFloat(row.Valor_Consultorias_Vendidas) || parseFloat(row.Valor_Consultorias_Vendidas_num) || 0;
                    faturamentoTotal += valorConsultorias;
                    faturamentoPorData[dataKey] += valorConsultorias;
                    
                    // Debug
                    faturamentoConsultoria += valorConsultorias;
                } else if (area === 'Recuperacao') {
                    const totalVendido = parseFloat(row.Total_Vendido) || parseFloat(row.Total_Vendido_num) || 0;
                    faturamentoTotal += totalVendido;
                    faturamentoPorData[dataKey] += totalVendido;
                    
                    // Debug
                    faturamentoRecuperacao += totalVendido;
                }
            });
            
            const lucroLiquido = faturamentoTotal - gastosTotal;
            const margemLucro = faturamentoTotal > 0 ? (lucroLiquido / faturamentoTotal) * 100 : 0;
            
            // Calcular mudan√ßas baseadas nos dados hist√≥ricos
            const datas = Object.keys(faturamentoPorData).sort();
            let faturamentoChange = 0;
            let lucroChange = 0;
            let margemChange = 0;
            
            if (datas.length >= 2) {
                const ultima = datas[datas.length - 1];
                const penultima = datas[datas.length - 2];
                
                const faturamentoUltimo = faturamentoPorData[ultima] || 0;
                const faturamentoPenultimo = faturamentoPorData[penultima] || 0;
                
                const gastosUltimo = gastosPorData[ultima] || 0;
                const gastosPenultimo = gastosPorData[penultima] || 0;
                
                const lucroUltimo = faturamentoUltimo - gastosUltimo;
                const lucroPenultimo = faturamentoPenultimo - gastosPenultimo;
                
                if (faturamentoPenultimo > 0) {
                    faturamentoChange = ((faturamentoUltimo - faturamentoPenultimo) / faturamentoPenultimo) * 100;
                }
                
                if (lucroPenultimo !== 0) {
                    lucroChange = lucroPenultimo !== 0 ? ((lucroUltimo - lucroPenultimo) / Math.abs(lucroPenultimo)) * 100 : 0;
                }
                
                const margemUltima = faturamentoUltimo > 0 ? (lucroUltimo / faturamentoUltimo) * 100 : 0;
                const margemPenultima = faturamentoPenultimo > 0 ? (lucroPenultimo / faturamentoPenultimo) * 100 : 0;
                margemChange = margemUltima - margemPenultima;
            }
            
            // Atualizar interface com anima√ß√£o
            updateValueWithAnimation('faturamentoTotal', 'R$ ' + faturamentoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
            updateValueWithAnimation('lucroTotal', 'R$ ' + lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
            updateValueWithAnimation('margemLucro', margemLucro.toFixed(1) + '%');
            
            // NOVO: Atualizar indicador de cota√ß√£o
            updateCurrencyIndicator();
            
            // Atualizar indicadores de mudan√ßa
            setTimeout(() => {
                updateChangeIndicator('faturamentoChange', faturamentoChange);
                updateChangeIndicator('lucroChange', lucroChange);
                updateChangeIndicator('margemChange', margemChange);
            }, 300);
            
            // NOVO: Atualizar debug detalhado
            updateFaturamentoDebug({
                trafego: faturamentoTrafego,
                revenue: faturamentoRevenue,
                consultoria: faturamentoConsultoria,
                recuperacao: faturamentoRecuperacao,
                gastos: gastosDebug,
                total: faturamentoTotal,
                lucro: lucroLiquido,
                margem: margemLucro
            });
            
            console.log('=== RESUMO EXECUTIVO ===');
            console.log(`üí± Cota√ß√£o USD/BRL: R$ ${dollarRate.toFixed(4)} (${dollarRateSource})`);
            console.log(`Faturamento Total: R$ ${faturamentoTotal.toLocaleString('pt-BR')}`);
            console.log(`  - Tr√°fego: R$ ${faturamentoTrafego.toLocaleString('pt-BR')}`);
            console.log(`  - Revenue: R$ ${faturamentoRevenue.toLocaleString('pt-BR')} (convertido de USD)`);
            console.log(`  - Consultoria: R$ ${faturamentoConsultoria.toLocaleString('pt-BR')}`);
            console.log(`  - Recupera√ß√£o: R$ ${faturamentoRecuperacao.toLocaleString('pt-BR')}`);
            console.log(`Gastos Total: R$ ${gastosTotal.toLocaleString('pt-BR')}`);
            console.log(`Lucro L√≠quido: R$ ${lucroLiquido.toLocaleString('pt-BR')}`);
            console.log(`Margem de Lucro: ${margemLucro.toFixed(1)}%`);
            console.log(`Mudan√ßas: Faturamento ${faturamentoChange.toFixed(1)}%, Lucro ${lucroChange.toFixed(1)}%, Margem ${margemChange.toFixed(1)}%`);
        }

        // NOVA FUN√á√ÉO: Atualizar indicador de cota√ß√£o
        function updateCurrencyIndicator() {
            const currentRateEl = document.getElementById('currentRate');
            const rateSourceEl = document.getElementById('rateSource');
            
            if (currentRateEl && rateSourceEl) {
                currentRateEl.textContent = `R$ ${dollarRate.toFixed(4)}`;
                
                const sourceText = dollarRateSource === 'api-exchangerate' ? 'API LIVE' : 
                                 dollarRateSource === 'api-awesomeapi' ? 'API BR' :
                                 'FIXO';
                                 
                const sourceColor = dollarRateSource.includes('api') ? 'var(--accent-success)' : 'var(--accent-warning)';
                
                rateSourceEl.textContent = sourceText;
                rateSourceEl.style.background = sourceColor;
            }
        }

        // NOVA FUN√á√ÉO: Atualizar valor com anima√ß√£o
        function updateValueWithAnimation(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.style.animation = 'countUp 0.6s ease-out';
            element.textContent = newValue;
            
            setTimeout(() => {
                element.style.animation = '';
            }, 600);
        }

        // FUN√á√ÉO MELHORADA: Atualizar indicadores de mudan√ßa
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isPositive = change > 0;
            const isNeutral = Math.abs(change) < 0.1;
            const isNoData = change === 0 && filteredData.length > 0;
            
            if (isNoData) {
                element.className = 'kpi-change neutral';
                element.innerHTML = 'üìä Dados insuficientes';
                element.style.fontSize = '0.75rem';
            } else {
                element.className = `kpi-change ${isNeutral ? 'neutral' : isPositive ? 'positive' : 'negative'}`;
                element.innerHTML = `
                    ${isNeutral ? '‚Üí' : isPositive ? '‚Üó' : '‚Üò'} ${Math.abs(change).toFixed(1)}%
                `;
                element.style.fontSize = '0.875rem';
            }
        }

        function calculateIndicatorValue(values, type) {
            if (values.length === 0) return 0;
            
            switch (type) {
                case 'median':
                    const sorted = [...values].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
                case 'average':
                    return values.reduce((a, b) => a + b, 0) / values.length;
                case 'percentage':
                    return values.reduce((a, b) => a + b, 0) / values.length;
                case 'exact':
                    return values[values.length - 1];
                default:
                    return values.reduce((a, b) => a + b, 0);
            }
        }

        function formatValue(value, type, currency = 'BRL') {
            if (type === 'currency') {
                const symbol = currency === 'USD' ? '$' : 'R$';
                return symbol + ' ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
            if (type === 'average') {
                const symbol = currency === 'USD' ? '$' : 'R$';
                return symbol + ' ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
            if (type === 'percentage') {
                return value.toFixed(2) + '%';
            }
            if (type === 'exact') {
                return Math.round(value).toString();
            }
            return value.toLocaleString('pt-BR');
        }

        function generateAreasWithCharts() {
            const areasContainer = document.getElementById('areasContainer');
            areasContainer.innerHTML = '';

            Object.keys(areaConfig).forEach(area => {
                const areaData = filteredData.filter(row => row.Tipo_Formulario === area);
                
                if (areaData.length === 0) return;

                const config = areaConfig[area];
                
                const areaSection = document.createElement('div');
                areaSection.className = 'area-section';
                
                const areaHeader = document.createElement('div');
                areaHeader.className = 'area-header';
                areaHeader.innerHTML = `
                    <div class="area-title">
                        <span class="area-badge ${config.badge}">${area}</span>
                        <span>${config.indicators.length} Indicators</span>
                    </div>
                `;
                
                areaSection.appendChild(areaHeader);
                
                // Special handling for Revenue area with tabs
                if (area === 'Revenue') {
                    const tabsContainer = document.createElement('div');
                    tabsContainer.className = 'tabs-container';
                    
                    // Tabs header
                    const tabsHeader = document.createElement('div');
                    tabsHeader.className = 'tabs-header';
                    tabsHeader.innerHTML = `
                        <button class="tab-btn active" onclick="switchTab('revenue', this)">Revenue</button>
                        <button class="tab-btn" onclick="switchTab('atendentes', this)">Registro de Atendentes</button>
                    `;
                    
                    // Revenue tab content
                    const revenueTabContent = document.createElement('div');
                    revenueTabContent.className = 'tab-content active';
                    revenueTabContent.id = 'revenue-tab';
                    
                    const kpiGrid = document.createElement('div');
                    kpiGrid.className = 'kpi-grid';
                    
                    config.indicators.forEach(indicator => {
                        const values = [];
                        
                        areaData.forEach(row => {
                            const numField = indicator.field + '_num';
                            if (row[numField] !== undefined) {
                                values.push(row[numField]);
                            } else if (row[indicator.field]) {
                                const val = parseFloat(row[indicator.field]);
                                if (!isNaN(val)) values.push(val);
                            }
                        });
                        
                        if (values.length === 0) return;

                        const calculatedValue = calculateIndicatorValue(values, indicator.type);
                        const lastValue = values[values.length - 1] || 0;
                        const prevValue = values[values.length - 2] || lastValue;
                        const change = prevValue ? ((lastValue - prevValue) / prevValue * 100) : 0;

                        const kpiCard = document.createElement('div');
                        kpiCard.className = 'kpi-card';
                        
                        const fieldName = indicator.field.replace(/_/g, ' ');
                        
                        kpiCard.innerHTML = `
                            <div class="kpi-header">
                                <span class="kpi-emoji">${indicator.emoji}</span>
                                <div class="kpi-title">${fieldName}</div>
                            </div>
                            <div class="kpi-value">${formatValue(calculatedValue, indicator.type, indicator.currency)}</div>
                            <div class="kpi-change ${change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral'}">
                                ${change > 0 ? '‚Üó' : change < 0 ? '‚Üò' : '‚Üí'} ${Math.abs(change).toFixed(1)}%
                            </div>
                        `;
                        
                        kpiGrid.appendChild(kpiCard);
                    });
                    
                    revenueTabContent.appendChild(kpiGrid);
                    
                    // Atendentes tab content
                    const atendentesTabContent = document.createElement('div');
                    atendentesTabContent.className = 'tab-content';
                    atendentesTabContent.id = 'atendentes-tab';
                    
                    const atendentesContainer = document.createElement('div');
                    atendentesContainer.className = 'atendentes-container';
                    
                    generateAtendentesContent(atendentesContainer);
                    atendentesTabContent.appendChild(atendentesContainer);
                    
                    tabsContainer.appendChild(tabsHeader);
                    tabsContainer.appendChild(revenueTabContent);
                    tabsContainer.appendChild(atendentesTabContent);
                    
                    areaSection.appendChild(tabsContainer);
                    
                } else {
                    // Regular area without tabs
                    const kpiGrid = document.createElement('div');
                    kpiGrid.className = 'kpi-grid';
                    
                    config.indicators.forEach(indicator => {
                        const values = [];
                        
                        areaData.forEach(row => {
                            const numField = indicator.field + '_num';
                            if (row[numField] !== undefined) {
                                values.push(row[numField]);
                            } else if (row[indicator.field]) {
                                const val = parseFloat(row[indicator.field]);
                                if (!isNaN(val)) values.push(val);
                            }
                        });
                        
                        if (values.length === 0) return;

                        const calculatedValue = calculateIndicatorValue(values, indicator.type);
                        const lastValue = values[values.length - 1] || 0;
                        const prevValue = values[values.length - 2] || lastValue;
                        const change = prevValue ? ((lastValue - prevValue) / prevValue * 100) : 0;

                        const kpiCard = document.createElement('div');
                        kpiCard.className = 'kpi-card';
                        
                        const fieldName = indicator.field.replace(/_/g, ' ');
                        
                        kpiCard.innerHTML = `
                            <div class="kpi-header">
                                <span class="kpi-emoji">${indicator.emoji}</span>
                                <div class="kpi-title">${fieldName}</div>
                            </div>
                            <div class="kpi-value">${formatValue(calculatedValue, indicator.type, indicator.currency)}</div>
                            <div class="kpi-change ${change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral'}">
                                ${change > 0 ? '‚Üó' : change < 0 ? '‚Üò' : '‚Üí'} ${Math.abs(change).toFixed(1)}%
                            </div>
                        `;
                        
                        kpiGrid.appendChild(kpiCard);
                    });
                    
                    areaSection.appendChild(kpiGrid);
                }
                
                const chartCard = document.createElement('div');
                chartCard.className = 'chart-card glass-card';
                const chartId = 'chart-' + area.replace(/\s+/g, '') + '-' + Math.random().toString(36).substr(2, 5);
                chartCard.innerHTML = `
                    <div class="chart-title">${area} Performance Trends</div>
                    <div class="chart-container">
                        <canvas id="${chartId}"></canvas>
                    </div>
                `;
                
                areaSection.appendChild(chartCard);
                areasContainer.appendChild(areaSection);
                
                setTimeout(() => {
                    createAreaChart(area, areaData, config, chartId);
                }, 300 + Object.keys(areaConfig).indexOf(area) * 200);
            });
        }

        function createAreaChart(area, areaData, config, chartId) {
            try {
                const ctx = document.getElementById(chartId);
                if (!ctx) return;
                
                const context = ctx.getContext('2d');
                
                areaData.sort((a, b) => {
                    if (!a.parsedDate || !b.parsedDate) return 0;
                    return a.parsedDate - b.parsedDate;
                });
                
                const mainIndicators = config.indicators.slice(0, 3);
                const datasets = [];
                const labels = [];
                
                const dateMap = new Map();
                
                areaData.forEach(row => {
                    if (!row.parsedDate) return;
                    
                    const dateKey = row.parsedDate.toLocaleDateString('pt-BR');
                    if (!dateMap.has(dateKey)) {
                        dateMap.set(dateKey, {});
                        labels.push(dateKey);
                    }
                    
                    mainIndicators.forEach(indicator => {
                        const numField = indicator.field + '_num';
                        let value = 0;
                        
                        if (row[numField] !== undefined) {
                            value = row[numField];
                        } else if (row[indicator.field]) {
                            const val = parseFloat(row[indicator.field]);
                            if (!isNaN(val)) value = val;
                        }
                        
                        dateMap.get(dateKey)[indicator.field] = value;
                    });
                });

                mainIndicators.forEach((indicator, index) => {
                    const data = labels.map(label => dateMap.get(label)[indicator.field] || 0);
                    const colors = [config.color, config.color + 'CC', config.color + '99'];
                    
                    const fieldName = indicator.field.replace(/_/g, ' ');
                    
                    datasets.push({
                        label: `${indicator.emoji} ${fieldName}`,
                        data: data,
                        borderColor: colors[index] || config.color,
                        backgroundColor: (colors[index] || config.color) + '20',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        borderWidth: 3,
                        pointBackgroundColor: colors[index] || config.color,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    });
                });

                if (datasets.length === 0 || labels.length === 0) {
                    document.getElementById(chartId).parentElement.innerHTML = `
                        <div class="no-data">Insufficient data for chart</div>
                    `;
                    return;
                }

                charts[chartId] = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#f8fafc'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                                titleColor: '#f8fafc',
                                bodyColor: '#cbd5e1',
                                borderColor: config.color,
                                borderWidth: 2,
                                cornerRadius: 12,
                                padding: 12
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(139, 92, 246, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(139, 92, 246, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });

            } catch (error) {
                console.error(`Chart error for ${area}:`, error);
                document.getElementById(chartId).parentElement.innerHTML = `
                    <div class="error-message">Error generating chart for ${area}</div>
                `;
            }
        }

        function generatePieCharts() {
            const pieChartsGrid = document.getElementById('pieChartsGrid');
            pieChartsGrid.innerHTML = '';

            const lucroData = {};
            filteredData.forEach(row => {
                const area = row.Tipo_Formulario;
                
                let lucro = 0;
                if (area === 'Tr√°fego') {
                    const vendas = parseFloat(row.Vendas) || parseFloat(row.Vendas_num) || 0;
                    const gasto = parseFloat(row.Gasto) || parseFloat(row.Gasto_num) || 0;
                    lucro = vendas - gasto;
                } else if (area === 'Revenue') {
                    lucro = parseFloat(row.Valor_Depositado) || parseFloat(row.Valor_Depositado_num) || 0;
                } else if (area === 'Consultoria') {
                    lucro = parseFloat(row.Valor_Consultorias_Vendidas) || parseFloat(row.Valor_Consultorias_Vendidas_num) || 0;
                } else if (area === 'Recuperacao') {
                    lucro = parseFloat(row.Total_Vendido) || parseFloat(row.Total_Vendido_num) || 0;
                }
                
                if (lucro > 0) {
                    lucroData[area] = (lucroData[area] || 0) + lucro;
                }
            });

            if (Object.keys(lucroData).length > 0) {
                createPieChart('pieChartsGrid', 'Lucro por Departamento', lucroData, 
                    ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']);
            }

            const faturamentoData = {};
            filteredData.forEach(row => {
                if (row.Produto) {
                    const area = row.Tipo_Formulario;
                    let faturamento = 0;
                    
                    if (area === 'Tr√°fego') {
                        faturamento = parseFloat(row.Vendas) || parseFloat(row.Vendas_num) || 0;
                    } else if (area === 'Revenue') {
                        faturamento = parseFloat(row.Valor_Depositado) || parseFloat(row.Valor_Depositado_num) || 0;
                    } else if (area === 'Consultoria') {
                        faturamento = parseFloat(row.Valor_Consultorias_Vendidas) || parseFloat(row.Valor_Consultorias_Vendidas_num) || 0;
                    } else if (area === 'Recuperacao') {
                        faturamento = parseFloat(row.Total_Vendido) || parseFloat(row.Total_Vendido_num) || 0;
                    }
                    
                    if (faturamento > 0) {
                        faturamentoData[row.Produto] = (faturamentoData[row.Produto] || 0) + faturamento;
                    }
                }
            });

            if (Object.keys(faturamentoData).length > 1) {
                createPieChart('pieChartsGrid', 'Faturamento por Produto', faturamentoData, 
                    ['#06b6d4', '#8b5cf6', '#dc2626', '#d97706', '#059669']);
            }
        }

        function createPieChart(containerId, title, data, colors) {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card glass-card';
            const chartId = 'pie-' + Math.random().toString(36).substr(2, 9);
            chartCard.innerHTML = `
                <div class="chart-title">${title}</div>
                <div class="pie-chart-container">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
            
            document.getElementById(containerId).appendChild(chartCard);
            
            setTimeout(() => {
                try {
                    const ctx = document.getElementById(chartId).getContext('2d');
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                data: Object.values(data),
                                backgroundColor: colors,
                                borderWidth: 3,
                                borderColor: 'rgba(17, 24, 39, 0.8)',
                                hoverOffset: 15,
                                hoverBorderWidth: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true,
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        },
                                        color: '#f8fafc'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(17, 24, 39, 0.95)',
                                    titleColor: '#f8fafc',
                                    bodyColor: '#cbd5e1',
                                    borderColor: '#8b5cf6',
                                    borderWidth: 2,
                                    cornerRadius: 12,
                                    padding: 12
                                }
                            },
                            cutout: '70%'
                        }
                    });
                } catch (error) {
                    console.error('Pie chart error:', error);
                    chartCard.innerHTML = `
                        <div class="chart-title">${title}</div>
                        <div class="no-data">Error generating chart</div>
                    `;
                }
            }, 100);
        }

        function generateObservations() {
            const container = document.getElementById('observationsContainer');
            container.innerHTML = '';

            const observations = [];
            
            filteredData.forEach(row => {
                const area = row.Tipo_Formulario;
                const config = areaConfig[area];
                
                if (config && config.observation && row[config.observation]) {
                    observations.push({
                        date: row.parsedDate,
                        area: area,
                        text: row[config.observation],
                        badge: config.badge
                    });
                }
            });

            observations.sort((a, b) => b.date - a.date);

            if (observations.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhuma observa√ß√£o encontrada</div>';
                return;
            }

            observations.slice(0, 10).forEach(obs => {
                const obsItem = document.createElement('div');
                obsItem.className = 'observation-item';
                
                obsItem.innerHTML = `
                    <div class="observation-header">
                        <div class="observation-date">${obs.date.toLocaleDateString('pt-BR')}</div>
                        <span class="area-badge ${obs.badge}">${obs.area}</span>
                    </div>
                    <div class="observation-text">${obs.text}</div>
                `;
                
                container.appendChild(obsItem);
            });
        }

        function generateDataTable() {
            const container = document.getElementById('dataTableContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum dado encontrado</div>';
                return;
            }

            const mainColumns = ['Data', 'Tipo_Formulario', 'Holding', 'Produto'];
            const activeAreas = [...new Set(filteredData.map(row => row.Tipo_Formulario))];
            const dataColumns = [];
            
            activeAreas.forEach(area => {
                if (areaConfig[area]) {
                    areaConfig[area].indicators.slice(0, 4).forEach(indicator => {
                        if (!dataColumns.includes(indicator.field)) {
                            dataColumns.push(indicator.field);
                        }
                    });
                }
            });

            const allColumns = [...mainColumns, ...dataColumns.slice(0, 6)];

            let tableHTML = `
                <table>
                    <thead>
                        <tr>${allColumns.map(col => `<th>${col.replace(/_/g, ' ')}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
            `;

            filteredData.slice(0, 30).forEach(row => {
                tableHTML += '<tr>';
                allColumns.forEach(col => {
                    let value = row[col];
                    if (col === 'Data' && row.parsedDate) {
                        value = row.parsedDate.toLocaleDateString('pt-BR');
                    } else if (typeof value === 'number') {
                        value = value.toLocaleString('pt-BR');
                    } else if (!value) {
                        value = '-';
                    }
                    tableHTML += `<td>${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            
            if (filteredData.length > 30) {
                tableHTML += `<p style="text-align: center; margin-top: 15px; color: #94a3b8;">
                    Mostrando os primeiros 30 de ${filteredData.length} registros
                </p>`;
            }
            
            container.innerHTML = tableHTML;
        }

        // NOVA FUN√á√ÉO: Toggle debug do faturamento
        function toggleFaturamentoDebug() {
            const debugInfo = document.getElementById('faturamentoDebugInfo');
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
            } else {
                debugInfo.style.display = 'none';
            }
        }

        // NOVA FUN√á√ÉO: Atualizar debug detalhado do faturamento
        function updateFaturamentoDebug(data) {
            const debugContent = document.getElementById('faturamentoDebugContent');
            if (!debugContent) return;
            
            const percentTrafego = data.total > 0 ? (data.trafego / data.total * 100).toFixed(1) : 0;
            const percentRevenue = data.total > 0 ? (data.revenue / data.total * 100).toFixed(1) : 0;
            const percentConsultoria = data.total > 0 ? (data.consultoria / data.total * 100).toFixed(1) : 0;
            const percentRecuperacao = data.total > 0 ? (data.recuperacao / data.total * 100).toFixed(1) : 0;
            
            // Calcular valor original em USD para Revenue
            const revenueUsd = data.revenue / dollarRate;
            const rateInfo = dollarRateSource === 'api-exchangerate' ? 'ExchangeRate API' : 
                           dollarRateSource === 'api-awesomeapi' ? 'AwesomeAPI' :
                           'Cota√ß√£o Fixa';
            
            debugContent.innerHTML = `
                <!-- NOVO: Info da cota√ß√£o -->
                <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; color: white;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">üí±</span>
                        <strong>Cota√ß√£o do D√≥lar</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.25rem; font-weight: 700;">USD 1 = R$ ${dollarRate.toFixed(4)}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">${rateInfo}</span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 1.5rem;">
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <h5 style="color: #3b82f6; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üöÄ Tr√°fego - Vendas
                        </h5>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>R$ ${data.trafego.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            <span style="background: rgba(59, 130, 246, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">${percentTrafego}%</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #10b981;">
                        <h5 style="color: #10b981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üíµ Revenue - Revenue Share
                        </h5>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>R$ ${data.revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            <span style="background: rgba(16, 185, 129, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">${percentRevenue}%</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); display: flex; justify-content: space-between;">
                            <span>üí∞ Original: USD ${revenueUsd.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            <span>üîÑ Convertido automaticamente</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <h5 style="color: #f59e0b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üéØ Consultoria - Valor Vendido
                        </h5>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>R$ ${data.consultoria.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            <span style="background: rgba(245, 158, 11, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">${percentConsultoria}%</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ef4444;">
                        <h5 style="color: #ef4444; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîÑ Recupera√ß√£o - Total Vendido
                        </h5>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>R$ ${data.recuperacao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            <span style="background: rgba(239, 68, 68, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">${percentRecuperacao}%</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 2px solid var(--accent-primary);">
                        <h5 style="color: var(--accent-primary); margin-bottom: 1.5rem; text-align: center;">üìä RESUMO FINAL</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">FATURAMENTO TOTAL</div>
                                <div style="color: var(--accent-success); font-size: 1.5rem; font-weight: 700;">R$ ${data.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">GASTOS TOTAL</div>
                                <div style="color: var(--accent-danger); font-size: 1.5rem; font-weight: 700;">R$ ${data.gastos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">LUCRO L√çQUIDO</div>
                                <div style="color: ${data.lucro >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}; font-size: 1.5rem; font-weight: 700;">R$ ${data.lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">MARGEM</div>
                                <div style="color: ${data.margem >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}; font-size: 1.5rem; font-weight: 700;">${data.margem.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-glass);">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                            <strong style="color: var(--text-primary);">üí° F√≥rmula do C√°lculo:</strong><br>
                            Faturamento = Tr√°fego(Vendas-BRL) + Revenue(Revenue Share-USD‚ÜíBRL) + Consultoria(Valor Vendido-BRL) + Recupera√ß√£o(Total Vendido-BRL)<br>
                            Lucro L√≠quido = Faturamento Total - Gastos (Tr√°fego)<br>
                            Margem = (Lucro L√≠quido / Faturamento Total) √ó 100<br>
                            <strong style="color: var(--accent-warning);">üí± Revenue Share convertido de USD para BRL usando cota√ß√£o ${rateInfo}</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        // NOVA FUN√á√ÉO: Toggle debug info
        function toggleDebugInfo() {
            const debugInfo = document.getElementById('dateDebugInfo');
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
            } else {
                debugInfo.style.display = 'none';
            }
        }

        // NOVA FUN√á√ÉO: Mostrar todas as datas dispon√≠veis
        function showAllDates() {
            const debugInfo = document.getElementById('dateDebugInfo');
            const debugContent = document.getElementById('dateDebugContent');
            
            const allDates = csvData.map(row => ({
                original: row.Data,
                parsed: row.parsedDate ? row.parsedDate.toLocaleDateString('pt-BR') : 'ERRO',
                area: row.Tipo_Formulario
            }));
            
            const uniqueDates = [...new Set(allDates.map(d => d.parsed))].sort();
            
            debugContent.innerHTML = `
                <h5 style="color: var(--text-primary); margin-bottom: 1rem;">üìÖ Todas as datas no seu dataset:</h5>
                <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Datas √∫nicas (${uniqueDates.length}):</strong><br>
                    ${uniqueDates.join(' ‚Ä¢ ')}
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    üí° <strong>Dica:</strong> Use essas datas como refer√™ncia para seus filtros. 
                    Se n√£o v√™ uma data que esperava, verifique o formato no seu CSV.
                </p>
            `;
            
            debugInfo.style.display = 'block';
        }

        // Tab switching function
        function switchTab(tabType, button) {
            // Remove active class from all tab buttons
            const tabButtons = button.parentElement.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            button.classList.add('active');
            
            // Hide all tab contents
            const tabContents = button.parentElement.parentElement.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabType + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // Generate atendentes content
        function generateAtendentesContent(container) {
            // Filter data for atendentes (assuming it has specific fields)
            const atendentesData = filteredData.filter(row => 
                row.Nome_do_atendente || 
                row['Quantos atendimentos voc√™ realizou hoje?'] ||
                row['De 0 a 10, como voc√™ avalia a sua performance hoje?']
            );

            if (atendentesData.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum registro de atendente encontrado</div>';
                return;
            }

            // Group by atendente name
            const atendentesByName = {};
            atendentesData.forEach(row => {
                const nome = row.Nome_do_atendente || 'Atendente n√£o identificado';
                if (!atendentesByName[nome]) {
                    atendentesByName[nome] = [];
                }
                atendentesByName[nome].push(row);
            });

            // Generate cards for each atendente
            Object.keys(atendentesByName).forEach(nome => {
                const atendenteRecords = atendentesByName[nome];
                const latestRecord = atendenteRecords[atendenteRecords.length - 1];

                const atendenteCard = document.createElement('div');
                atendenteCard.className = 'atendente-card';

                // Header with name
                const header = document.createElement('div');
                header.className = 'atendente-header';
                header.innerHTML = `
                    <div class="atendente-name">${nome}</div>
                    <div class="atendente-badge">üë§ Atendente</div>
                `;

                // Metrics (KPIs)
                const metricsContainer = document.createElement('div');
                metricsContainer.className = 'atendente-metrics';

                const atendimentos = latestRecord['Quantos atendimentos voc√™ realizou hoje?'] || '0';
                const performance = latestRecord['De 0 a 10, como voc√™ avalia a sua performance hoje?'] || '0';
                const avaliacaoCliente = latestRecord['De 0 a 10, como voc√™ acha que o cliente avaliaria o seu atendimento hoje?'] || '0';

                metricsContainer.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-title">üìû Atendimentos Hoje</div>
                        <div class="metric-value">${atendimentos}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">‚≠ê Auto Avalia√ß√£o</div>
                        <div class="metric-value">${performance}/10</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">üòä Avalia√ß√£o Cliente</div>
                        <div class="metric-value">${avaliacaoCliente}/10</div>
                    </div>
                `;

                // Responses
                const responsesContainer = document.createElement('div');
                responsesContainer.className = 'atendente-responses';

                const questions = [
                    { field: 'Existe alguma demanda/pedido que se repetiu demais hoje?', label: 'üîÑ Demandas Repetidas' },
                    { field: 'Qual atendimento foi o mais dif√≠cil de resolver? Por qu√™?', label: 'üéØ Atendimento Dif√≠cil' },
                    { field: 'Conseguiu resolver todos os atendimentos?', label: '‚úÖ Resolu√ß√£o Completa' },
                    { field: 'Teve algo que dificultou seu trabalho hoje?', label: '‚ö†Ô∏è Dificuldades' },
                    { field: 'Alguma sugest√£o para melhorar nosso atendimento?', label: 'üí° Sugest√µes' },
                    { field: 'Como voc√™ est√° se sentindo hoje?', label: 'üòä Como se sente' }
                ];

                questions.forEach(question => {
                    const answer = latestRecord[question.field];
                    if (answer && answer.trim()) {
                        const responseItem = document.createElement('div');
                        responseItem.className = 'response-item';
                        responseItem.innerHTML = `
                            <div class="response-question">${question.label}</div>
                            <div class="response-answer">${answer}</div>
                        `;
                        responsesContainer.appendChild(responseItem);
                    }
                });

                atendenteCard.appendChild(header);
                atendenteCard.appendChild(metricsContainer);
                atendenteCard.appendChild(responsesContainer);
                container.appendChild(atendenteCard);
            });
        }
    </script>
</body>
</html>
